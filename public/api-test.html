<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #3a3a3a;
        }
        .result {
            margin-top: 10px;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        input {
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #3a3a3a;
            background: #1a1a1a;
            color: #fff;
            min-width: 200px;
        }
        h1 {
            color: #4CAF50;
        }
        h2 {
            color: #64B5F6;
            margin-top: 0;
        }
        .info {
            background: #1e3a5f;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ API Test Tool</h1>
    <div class="info">
        <strong>Backend URL:</strong> <span id="backendUrl">http://localhost:8000/api</span><br>
        <strong>Auth Token:</strong> <span id="authToken">Not logged in</span>
    </div>

    <!-- Test Backend Connection -->
    <div class="test-section">
        <h2>1. Test Backend Connection</h2>
        <button onclick="testBackend()">Test GET /items</button>
        <div id="backendResult" class="result"></div>
    </div>

    <!-- Test Favorites -->
    <div class="test-section">
        <h2>2. Test Favorites System</h2>
        <button onclick="getFavorites()">GET Favorites</button>
        <button onclick="addFavorite()">POST Add Favorite</button>
        <button onclick="removeFavorite()" class="danger">DELETE Favorite</button>
        <br>
        <input type="text" id="productId" placeholder="Product ID" value="">
        <div id="favoritesResult" class="result"></div>
    </div>

    <!-- Test Ratings -->
    <div class="test-section">
        <h2>3. Test Ratings System</h2>
        <button onclick="submitRating()">POST Submit Rating</button>
        <button onclick="getStoreRatings()">GET Store Ratings</button>
        <br>
        <input type="text" id="storeId" placeholder="Store ID" value="">
        <input type="text" id="ratingProductId" placeholder="Product ID" value="">
        <input type="number" id="rating" placeholder="Rating (1-5)" min="1" max="5" value="5">
        <div id="ratingsResult" class="result"></div>
    </div>

    <!-- Check Network Requests -->
    <div class="test-section">
        <h2>4. Network Monitor</h2>
        <button onclick="clearConsole()">Clear Console</button>
        <div id="networkLog" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let requestCount = 0;

        // Get auth token from localStorage
        function getAuthToken() {
            const token = localStorage.getItem('auth_token');
            document.getElementById('authToken').textContent = token ? 'Found âœ“' : 'Not found âœ—';
            return token;
        }

        // Update token display on load
        getAuthToken();

        // Log all requests
        function logRequest(method, url, status, data) {
            requestCount++;
            const log = document.getElementById('networkLog');
            const entry = document.createElement('div');
            entry.innerHTML = `<strong>${requestCount}. ${method} ${url}</strong> - ${status}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            log.insertBefore(entry, log.firstChild);
        }

        function clearConsole() {
            document.getElementById('networkLog').innerHTML = '';
            requestCount = 0;
        }

        async function makeRequest(method, endpoint, body = null) {
            const token = getAuthToken();
            const url = `${API_BASE}${endpoint}`;
            
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                logRequest(method, endpoint, response.status, data);
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                logRequest(method, endpoint, 'ERROR', error.message);
                return { success: false, error: error.message };
            }
        }

        // Test 1: Backend Connection
        async function testBackend() {
            const result = await makeRequest('GET', '/items');
            const div = document.getElementById('backendResult');
            if (result.success) {
                div.innerHTML = `<span class="success">âœ“ Backend is working!</span><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                div.innerHTML = `<span class="error">âœ— Backend not responding: ${result.error}</span>`;
            }
        }

        // Test 2: Favorites
        async function getFavorites() {
            const result = await makeRequest('GET', '/user/favorites');
            const div = document.getElementById('favoritesResult');
            if (result.success) {
                const count = result.data?.favorites?.length || result.data?.data?.length || 0;
                div.innerHTML = `<span class="success">âœ“ Found ${count} favorites</span><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                div.innerHTML = `<span class="error">âœ— Failed: ${result.error || result.data?.error}</span><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        async function addFavorite() {
            const productId = document.getElementById('productId').value;
            if (!productId) {
                alert('Please enter a Product ID');
                return;
            }
            const result = await makeRequest('POST', '/favorites/add', { productId });
            const div = document.getElementById('favoritesResult');
            if (result.success) {
                div.innerHTML = `<span class="success">âœ“ Added to favorites!</span><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                div.innerHTML = `<span class="error">âœ— Failed: ${result.data?.error || result.error}</span><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        async function removeFavorite() {
            const productId = document.getElementById('productId').value;
            if (!productId) {
                alert('Please enter a Product ID');
                return;
            }
            const result = await makeRequest('DELETE', `/user/favorites/${productId}`);
            const div = document.getElementById('favoritesResult');
            if (result.success) {
                div.innerHTML = `<span class="success">âœ“ Removed from favorites!</span><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                div.innerHTML = `<span class="error">âœ— Failed: ${result.data?.error || result.error}</span><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        // Test 3: Ratings
        async function submitRating() {
            const storeId = document.getElementById('storeId').value;
            const productId = document.getElementById('ratingProductId').value;
            const rating = parseInt(document.getElementById('rating').value);
            
            if (!storeId || !productId) {
                alert('Please enter Store ID and Product ID');
                return;
            }

            const result = await makeRequest('POST', '/ratings', { storeId, productId, rating });
            const div = document.getElementById('ratingsResult');
            if (result.success) {
                div.innerHTML = `<span class="success">âœ“ Rating submitted!</span><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                div.innerHTML = `<span class="error">âœ— Failed: ${result.data?.error || result.error}</span><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        async function getStoreRatings() {
            const storeId = document.getElementById('storeId').value;
            if (!storeId) {
                alert('Please enter Store ID');
                return;
            }
            const result = await makeRequest('GET', `/ratings/store/${storeId}`);
            const div = document.getElementById('ratingsResult');
            if (result.success) {
                const avg = result.data?.average || 0;
                const count = result.data?.count || 0;
                div.innerHTML = `<span class="success">âœ“ Average: ${avg}, Count: ${count}</span><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                div.innerHTML = `<span class="error">âœ— Failed: ${result.data?.error || result.error}</span><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }
    </script>
</body>
</html>
